<!DOCTYPE html>
<html lang="en">
    {% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic Management {{ title }}</title>
    <link rel="stylesheet" href="{% static 'css/clinic_ops.css' %}">
</head>
<body>
  <div class="header-bar">
    <div class="primary-header">
      <h1 class="title">Clinic Management - {{ title }}</h1>
      <h3 class="subtitle">Drag and drop students to assign them to clinics</h3>
      <h2 class="clinic-title-descriptor">Project Details</h2>
      <h2 class="clinic-assigned-descriptor">Assigned Students</h2>
      <div class="filters" id="filter-controls">
        <h3>Filters:</h3>
        <label for="major-filter">Filter by major:</label>
        <select id="major-filter">
          <option value="all">All</option>
          {% for major in majors %}
          <option value="{{ major.major }}">{{ major.major }}</option>
          {% endfor %}
        </select>
        <br />
        <label for="accepting-major">
          <input type="checkbox" id="accepting-major" />
          Show only clinics accepting selected major
        </label>
        <br />
        <label for="show-empty">
          <input type="checkbox" id="show-empty" />
          Show only clinics with fewer than min students
        </label>
        <br />
      </div>
    </div>
    <div class="secondary-header">
      <h2 class="student-details-descriptor">Student details</h2>
      <div class="links">
        <a href="/clinicManagementView/all/">All</a>
        {% for major in majors %}
          <a href="/clinicManagementView/{{major.major}}/">{{major.major}}</a>
        {% endfor %}
      </div>
      <button class="save-button" id="save-assignments">Save Assignments</button>
      <button class="reset-button" id="reset-assignments">Reset Assignments</button>
      <button class="csv-button" id="generate-csv">Generate CSV</button>
    </div>
  </div>
  </div>
  <!-- left clinics column -->
  <div class="clinics-board" aria-label="Clinics column">
        {% for clinic in clinics %}
        <div class="clinic-container item" data-clinic-id="{{ clinic.id }}" data-major="{{ clinic.department.major }}" data-is-general="{{ clinic.is_general }}" data-total="{{ clinic.current_students.count|default_if_none:0 }}" data-total-max="{{ clinic.total_max|default:0 }}" data-total-min="{{ clinic.total_min|default:0 }}" data-title="{{ clinic.title }}">
            <div class="clinic-card {{ clinic.department }}"
                 style="--color: {{ clinic.department.color }};">
                <div class="clinic-info">
                  <p class="clinic-title">{{ clinic.title }}</p>
                  <div class="clinic-capacity" aria-label="capacity">
                    <span class="min-capacity">{{ clinic.total_min|default:0 }}</span>
                    –
                    <span class="max-capacity">{{ clinic.total_max|default:0 }}</span>
                      {% if clinic.is_general %}
                        <span>(General)</span>
                        <span>{{ clinic.current_students.count }}</span>
                      {% else %}
                        <span>(By Discipline)</span>
                        <span>{{ clinic.current_students.count }}</span>
                      {% endif %}
                  </div>
                  <div class="clinic-managers">
                    Managed by:
                    <br><br>
                      {% for manager in clinic.clinic_mgmt.all %}
                        <a href="mailto:{{manager.email}}">{{ manager.first_name }} {{ manager.last_name }}</a> {%if not forloop.last%} | {%endif%}
                      {% endfor %}
                  </div>
                </div>

                <!-- New: inner grid for student items for this clinic -->
                <div class="clinic-inner" data-clinic-id="{{ clinic.id }}">
                  {% for student in clinic.assigned_students %}
                    <div class="student-item"
                        data-student-id="{{ student.id }}"
                        data-banner="{{ student.banner_id }}"
                        data-major="{{ student.major }}"
                        data-email="{{ student.email }}"
                        data-name="{{ student.first_name }} {{student.last_name }}"
                        {% if student.alternative_major %} 
                          style="--color: {{ student.major.color }}; background: linear-gradient(to right, var(--color) 0%, #fff 100%);"
                        {% else %} 
                          style="--color: {{ student.major.color }};" 
                        {% endif %}
                      >
                        <div class="student-card" 
                          {% if student.alternative_major %} 
                            style="--color: {{ student.major.color }}; background: linear-gradient(to right, var(--color) 0%, #fff 100%);"
                          {% else %} 
                            style="--color: {{ student.major.color }};" 
                          {% endif %}
                        >
                        <div class="student-name">{{ student.first_name }} {{ student.last_name }}</div>
                        <div class="student-meta">
                          {% if student.j_or_s %}{{ student.j_or_s }}{% endif %}
                          {% if student.email %}&nbsp;•&nbsp;{{ student.email|cut:"rowan.edu"|cut:"students."|cut:"@" }}{% endif %}
                        </div>
                      </div>
                      <button class="info" aria-label="More info about {{ student.first_name }} {{ student.last_name }}">i</button>
                    </div>
                  {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

  <!-- Students column in the center -->
  <div class="students-board" aria-label="Students board">
    <div class="students-board-header">
      <strong>Unassigned Students</strong>
    </div>
    <div class="students-board-inner">
      {% for student in unassigned_students %}
      <div class="student-item"
        data-student-id="{{ student.id }}"
        data-banner="{{ student.banner_id }}"
        data-major="{{ student.major }}"
        {% if student.alternative_major %} 
          style="--color: {{ student.major.color }}; background: linear-gradient(to right, var(--color) 0%, #fff 100%);"
        {% else %} 
          style="--color: {{ student.major.color }};" 
        {% endif %}
      >
        <div class="student-card" 
          {% if student.alternative_major %} 
            style="--color: {{ student.major.color }}; background: linear-gradient(to right, var(--color) 0%, #fff 100%);"
          {% else %} 
            style="--color: {{ student.major.color }};" 
          {% endif %}
        >
        
          <div class="student-name">{{ student.first_name }} {{ student.last_name }}</div>
          <div class="student-meta">
            {% if student.j_or_s %}{{ student.j_or_s }}{% endif %}
            {% if student.email %}&nbsp;•&nbsp;{{ student.email|cut:"rowan.edu"|cut:"students."|cut:"@" }}{% endif %}
          </div>
        </div>
        <button class="info" aria-label="More info about {{ student.first_name }} {{ student.last_name }}">i</button>
      </div>
      {% endfor %}
    </div>
  </div>
</body>

  <!-- main content to the right -->
  <div class="main-content">
    <div class="drag-container"></div>
    <div id="details-pane">
      <p>Select a student or clinic to view details here.</p>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/muuri@0.9.5/dist/muuri.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/web-animations-js@2.3.2/web-animations.min.js"></script>
<script src="{% static 'js/clinic_ops.js' %}"></script>
</html>